/**
 * we-cropper v1.4.0
 * (c) 2022 dlhandsome
 * @license MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.WeCropper=e()}(this,function(){"use strict";var t=void 0,e=["touchstarted","touchmoved","touchended"],o={strokeStyle:"setStrokeStyle",fillStyle:"setFillStyle",lineWidth:"setLineWidth"};function r(n){for(var o=[],t=arguments.length-1;0<t--;)o[t]=arguments[t+1];e.forEach(function(t,e){void 0!==o[e]&&(n[t]=o[e])})}function n(){return t=t||wx.getSystemInfoSync()}function v(t,e,n){"2d"===t.type?t.ctx[e]=n:t.ctx[o[e]](n)}var a={},i={id:{default:"cropper",get:function(){return a.id},set:function(t){"string"!=typeof t&&console.error("id\uff1a"+t+" is invalid"),a.id=t}},width:{default:750,get:function(){return a.width},set:function(t){"number"!=typeof t&&console.error("width\uff1a"+t+" is invalid"),a.width=t}},height:{default:750,get:function(){return a.height},set:function(t){"number"!=typeof t&&console.error("height\uff1a"+t+" is invalid"),a.height=t}},pixelRatio:{default:n().pixelRatio,get:function(){return a.pixelRatio},set:function(t){"number"!=typeof t&&console.error("pixelRatio\uff1a"+t+" is invalid"),a.pixelRatio=t}},scale:{default:2.5,get:function(){return a.scale},set:function(t){"number"!=typeof t&&console.error("scale\uff1a"+t+" is invalid"),a.scale=t}},zoom:{default:5,get:function(){return a.zoom},set:function(t){"number"!=typeof t?console.error("zoom\uff1a"+t+" is invalid"):(t<0||10<t)&&console.error("zoom should be ranged in 0 ~ 10"),a.zoom=t}},isround:{default:!1,get:function(){return a.isround},set:function(t){"boolean"!=typeof t&&console.error("isround\uff1a"+t+" is invalid"),a.isround=t}},src:{default:"",get:function(){return a.src},set:function(t){"string"!=typeof t&&console.error("src\uff1a"+t+" is invalid"),a.src=t}},cut:{default:{},get:function(){return a.cut},set:function(t){"object"!=typeof t&&console.error("cut\uff1a"+t+" is invalid"),a.cut=t}},boundStyle:{default:{},get:function(){return a.boundStyle},set:function(t){"object"!=typeof t&&console.error("boundStyle\uff1a"+t+" is invalid"),a.boundStyle=t}},onReady:{default:null,get:function(){return a.ready},set:function(t){a.ready=t}},onBeforeImageLoad:{default:null,get:function(){return a.beforeImageLoad},set:function(t){a.beforeImageLoad=t}},onImageLoad:{default:null,get:function(){return a.imageLoad},set:function(t){a.imageLoad=t}},onBeforeDraw:{default:null,get:function(){return a.beforeDraw},set:function(t){a.beforeDraw=t}}},c=n().windowWidth;function x(t){return"function"==typeof t}var u=["ready","beforeImageLoad","beforeDraw","imageLoad"];function s(r){return function(t){for(var o=[],e=arguments.length-1;0<e--;)o[e]=arguments[e+1];return void 0===t&&(t={}),new Promise(function(e,n){t.success=function(t){e(t)},t.fail=function(t){n(t)},r.apply(void 0,[t].concat(o))})}}function y(e,n){return void 0===n&&(n=!1),new Promise(function(t){e.draw&&e.draw(n,t)})}var m=s(wx.getImageInfo),w=s(wx.canvasToTempFilePath),h="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};(function(t,e){var n=h;function s(t){throw new r(t)}var o=e,e=t&&t.exports==o&&t,t="object"==typeof h&&h,r=(t.global!==t&&t.window!==t||(n=t),function(t){this.message=t}),d=(r.prototype=new Error,r.prototype.name="InvalidCharacterError","ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),c=/[\t\n\f\r ]/g,a={encode:function(t){t=String(t),/[^\0-\xFF]/.test(t)&&s("The string to be encoded contains characters outside of the Latin1 range.");for(var e,n,o,r,a=t.length%3,i="",c=-1,u=t.length-a;++c<u;)e=t.charCodeAt(c)<<16,n=t.charCodeAt(++c)<<8,o=t.charCodeAt(++c),i+=d.charAt((r=e+n+o)>>18&63)+d.charAt(r>>12&63)+d.charAt(r>>6&63)+d.charAt(63&r);return 2==a?(e=t.charCodeAt(c)<<8,n=t.charCodeAt(++c),i+=d.charAt((r=e+n)>>10)+d.charAt(r>>4&63)+d.charAt(r<<2&63)+"="):1==a&&(r=t.charCodeAt(c),i+=d.charAt(r>>2)+d.charAt(r<<4&63)+"=="),i},decode:function(t){for(var e,n,o=(t=String(t).replace(c,"")).length,r=((o=o%4==0?(t=t.replace(/==?$/,"")).length:o)%4!=1&&!/[^+a-zA-Z0-9/]/.test(t)||s("Invalid character: the string to be decoded is not correctly encoded."),0),a="",i=-1;++i<o;)n=d.indexOf(t.charAt(i)),e=r%4?64*e+n:n,r++%4&&(a+=String.fromCharCode(255&e>>(-2*r&6)));return a},version:"0.1.0"};if(o&&!o.nodeType)if(e)e.exports=a;else for(var i in a)a.hasOwnProperty(i)&&(o[i]=a[i]);else n.base64=a})(f={exports:{}},f.exports);var d=f.exports;function b(t){var e="";if("string"==typeof t)e=t;else for(var n=0;n<t.length;n++)e+=String.fromCharCode(t[n]);return d.encode(e)}function l(t,e,n,o,r,a,i){var c;void 0===i&&(i=function(){}),a=void 0===a?"png":a,a="image/"+a.toLowerCase().replace(/jpg/i,"jpeg").match(/png|jpeg|bmp|gif/)[0],/bmp/.test(a)?(c=function(t,e){t=function(t){var e=t.width,n=t.height,o=[66,77,255&(o=54+(r=e*n*3)),o>>8&255,o>>16&255,o>>24&255,0,0,0,0,54,0,0,0],r=[40,0,0,0,255&e,e>>8&255,e>>16&255,e>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,1,0,24,0,0,0,0,0,255&r,r>>8&255,r>>16&255,r>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],a=(4-3*e%4)%4,i=t.data,c="",u=e<<2,s=n,d=String.fromCharCode;do{for(var h=u*(s-1),l="",f=0;f<e;f++){var g=f<<2;l+=d(i[h+g+2])+d(i[h+g+1])+d(i[h+g])}for(var p=0;p<a;p++)l+=String.fromCharCode(0)}while(c+=l,--s);return b(o.concat(r))+b(c)}(t);x(i)&&i("data:image/"+a+";base64,"+t,e)},wx.canvasGetImageData({canvasId:t,x:e,y:n,width:o,height:r,success:function(t){c(t,null)},fail:function(t){c(null,t)}})):console.error("\u6682\u4e0d\u652f\u6301\u751f\u6210'"+a+"'\u7c7b\u578b\u7684base64\u56fe\u7247")}var C=function(t,e){return l((t=void 0===t?{}:t).canvasId,t.x,t.y,t.width,t.height,"bmp",e=void 0===e?function(){}:e)};var f={touchStart:function(t){var e=t.touches,n=e[0],e=e[1];this.src&&(r(this,!0,null,null),this.__oneTouchStart(n),2<=t.touches.length)&&this.__twoTouchStart(n,e)},touchMove:function(t){var e=t.touches,n=e[0],e=e[1];this.src&&(r(this,null,!0),1===t.touches.length&&this.__oneTouchMove(n),2<=t.touches.length)&&this.__twoTouchMove(n,e)},touchEnd:function(t){this.src&&(r(this,!1,!1,!0),this.__xtouchEnd())}};function g(t){var e=this,n={};return Object.defineProperties(e,i),Object.keys(i).forEach(function(t){n[t]=i[t].default}),Object.assign(e,n,t),e.prepare(),e.attachPage(),e.createCtx(),e.observer(),e.cutt(),e.methods(),e.init(),e.update(),e}return g.prototype.init=function(){var t=this,e=t.src;return t.version="1.4.0","function"==typeof t.onReady&&t.onReady(t.ctx,t),e?t.pushOrign(e):t.updateCanvas(),r(t,!1,!1,!1),t.oldScale=1,t.newScale=1,t},Object.assign(g.prototype,f),g.prototype.prepare=function(){var n=this;n.attachPage=function(){var t=getCurrentPages(),t=t[t.length-1];Object.defineProperty(t,"wecropper",{get:function(){return console.warn("Instance will not be automatically bound to the page after v1.4.0\n\nPlease use a custom instance name instead\n\nExample: \nthis.mycropper = new WeCropper(options)\n\n// ...\nthis.mycropper.getCropperImage()"),n},configurable:!0})},n.createCtx=function(){var t=n.id,e=n.targetId;t?(n.ctx=n.ctx||wx.createCanvasContext(t),n.targetCtx=n.targetCtx||wx.createCanvasContext(e),"function"!=typeof n.ctx.setStrokeStyle&&(n.type="2d")):console.error("constructor: create canvas context failed, 'id' must be valuable")},n.deviceRadio=c/750},g.prototype.observer=function(){var o=this;o.on=function(t,e){var n;return-1<u.indexOf(t)?x(e)&&("ready"===t?e(o):o["on"+((n=t).charAt(0).toUpperCase()+n.slice(1))]=e):console.error("event: "+t+" is invalid"),o}},g.prototype.methods=function(){var a=this,i=a.width,c=a.height,u=a.id,s=a.targetId,d=a.pixelRatio,t=a.cut,h=t.x,l=(void 0===h&&(h=0),t.y),f=(void 0===l&&(l=0),t.width),g=(void 0===f&&(f=i),t.height),p=(void 0===g&&(g=c),t.isround);void 0===p&&(p=!1),a.updateCanvas=function(t){return a.croperTarget&&a.ctx.drawImage(a.croperTarget,a.imgLeft,a.imgTop,a.scaleWidth,a.scaleHeight),x(a.onBeforeDraw)&&a.onBeforeDraw(a.ctx,a),a.setBoundStyle(a.boundStyle),"2d"!==a.type&&a.ctx.draw(!1,t),t&&t(),a},a.pushOrigin=a.pushOrign=function(e){return a.src=e,x(a.onBeforeImageLoad)&&a.onBeforeImageLoad(a.ctx,a),o=a,r=e,new Promise(function(t,e){var n;"2d"===o.type?((n=o.canvas.createImage()).onload=function(){t(n)},n.onerror=function(t){e(t)},n.src=r):t(r)}).then(function(t){return a.croperTarget=t,m({src:e}).then(function(t){t=t.width/t.height;return t<f/g?(a.rectX=h,a.baseWidth=f,a.baseHeight=f/t,a.rectY=l-Math.abs((g-a.baseHeight)/2)):(a.rectY=l,a.baseWidth=g*t,a.baseHeight=g,a.rectX=h-Math.abs((f-a.baseWidth)/2)),a.imgLeft=a.rectX,a.imgTop=a.rectY,a.scaleWidth=a.baseWidth,a.scaleHeight=a.baseHeight,a.update(),new Promise(function(t){a.updateCanvas(t)})}).then(function(){x(a.onImageLoad)&&a.onImageLoad(a.ctx,a)})});var o,r},a.removeImage=function(){return a.src="",a.croperTarget="","2d"===a.type?a.ctx.clearRect(0,0,a.canvas.width,a.canvas.height):y(a.ctx)},a.getCropperBase64=function(t){C({canvasId:u,x:h,y:l,width:f,height:g},t=void 0===t?function(){}:t)},a.getCropperImage=function(t,e){var n=Object.assign({fileType:"png"},t),o=x(t)?t:x(e)?e:null,r={canvasId:u,x:h,y:l,width:f,height:g},t=("2d"===a.type&&(r.canvas=a.canvas),function(){return Promise.resolve()});return(t=n.original?function(){return a.targetCtx.drawImage(a.croperTarget,a.imgLeft*d,a.imgTop*d,a.scaleWidth*d,a.scaleHeight*d),r={canvasId:s,x:h*d,y:l*d,width:f*d,height:g*d},y(a.targetCtx)}:t)().then(function(){Object.assign(r,n);var t=r.componentContext?[r,r.componentContext]:[r];return w.apply(null,t)}).then(function(t){return p?(a.ctx.clearRect(0,0,i,c),a.ctx.beginPath(),a.ctx.arc(i/2,c/2,f/2,0,2*Math.PI,1),a.ctx.clip(),a.ctx.drawImage(t.tempFilePath,i/2-f/2,c/2-g/2,f,g),a.ctx.closePath(),new Promise(function(e){a.ctx.draw(!0,function(){Object.assign(r,n,{canvasId:u});var t=r.componentContext?[r,r.componentContext]:[r];e(w.apply(null,t))})})):t}).then(function(t){t=t.tempFilePath;return o?o.call(a,t,null):t}).catch(function(t){if(!o)throw t;o.call(a,null,t)})}},g.prototype.cutt=function(){var u=this,s=u.width,d=u.height,t=u.cut,h=t.x,l=(void 0===h&&(h=0),t.y),f=(void 0===l&&(l=0),t.width),g=(void 0===f&&(f=s),t.height),p=(void 0===g&&(g=d),t.isround);void 0===p&&(p=!1),u.outsideBound=function(t,e){u.imgLeft=h<=t?h:u.scaleWidth+t-h<=f?h+f-u.scaleWidth:t,u.imgTop=l<=e?l:u.scaleHeight+e-l<=g?l+g-u.scaleHeight:e},u.setBoundStyle=function(t){var e,n,o,r,a,i=(t=void 0===t?{}:t).color,c=(void 0===i&&(i="#04b00f"),t.mask),t=(void 0===c&&(c="rgba(0, 0, 0, 0.3)"),t.lineWidth);void 0===t&&(t=1),p?(o=i,r=c,a=t,u.ctx.beginPath(),v(u,"fillStyle",r),u.ctx.lineTo(s,0),u.ctx.lineTo(s,d/2),u.ctx.lineTo(s-f/2,d/2),u.ctx.arc(s/2,d/2,f/2,0,2*Math.PI,1),u.ctx.lineTo(s/2-f/2,d/2),u.ctx.lineTo(s,d/2),u.ctx.lineTo(s,d),u.ctx.lineTo(0,d),u.ctx.lineTo(0,0),u.ctx.fill(),u.ctx.closePath(),u.ctx.beginPath(),v(u,"strokeStyle",o),v(u,"lineWidth",a),u.ctx.arc(s/2,d/2,f/2+a+1,0,2*Math.PI,1),u.ctx.stroke(),u.ctx.closePath()):(e=i,r=c,o=[{start:{x:h-(o=(n=t)/2),y:l+10-o},step1:{x:h-o,y:l-o},step2:{x:h+10-o,y:l-o}},{start:{x:h-o,y:l+g-10+o},step1:{x:h-o,y:l+g+o},step2:{x:h+10-o,y:l+g+o}},{start:{x:h+f-10+o,y:l-o},step1:{x:h+f+o,y:l-o},step2:{x:h+f+o,y:l+10-o}},{start:{x:h+f+o,y:l+g-10+o},step1:{x:h+f+o,y:l+g+o},step2:{x:h+f-10+o,y:l+g+o}}],u.ctx.beginPath(),v(u,"fillStyle",r),u.ctx.fillRect(0,0,h,d),u.ctx.fillRect(h,0,f,l),u.ctx.fillRect(h,l+g,f,d-l-g),u.ctx.fillRect(h+f,0,s-h-f,d),u.ctx.fill(),o.forEach(function(t){u.ctx.beginPath(),v(u,"strokeStyle",e),v(u,"lineWidth",n),u.ctx.moveTo(t.start.x,t.start.y),u.ctx.lineTo(t.step1.x,t.step1.y),u.ctx.lineTo(t.step2.x,t.step2.y),u.ctx.stroke()}))}},g.prototype.update=function(){var c=this;c.src&&(c.__oneTouchStart=function(t){c.touchX0=Math.round(t.x),c.touchY0=Math.round(t.y)},c.__oneTouchMove=function(t){if(c.touchended)return c.updateCanvas();var e=Math.round(t.x-c.touchX0),t=Math.round(t.y-c.touchY0),e=Math.round(c.rectX+e),t=Math.round(c.rectY+t);c.outsideBound(e,t),c.updateCanvas()},c.__twoTouchStart=function(t,e){var n;c.touchX1=Math.round(c.rectX+c.scaleWidth/2),c.touchY1=Math.round(c.rectY+c.scaleHeight/2),n=Math.round(e.x-t.x),e=Math.round(e.y-t.y),t=Math.round(Math.sqrt(n*n+e*e)),c.oldDistance=t},c.__twoTouchMove=function(t,e){var n,o=c.oldScale,r=c.oldDistance,a=c.scale,i=c.zoom,t=(c.newScale=(o=o,r=r,i=i,t=t,e=e,n=Math.round(e.x-t.x),e=Math.round(e.y-t.y),o+.001*i*(Math.round(Math.sqrt(n*n+e*e))-r)),c.newScale<=1&&(c.newScale=1),c.newScale>=a&&(c.newScale=a),c.scaleWidth=Math.round(c.newScale*c.baseWidth),c.scaleHeight=Math.round(c.newScale*c.baseHeight),Math.round(c.touchX1-c.scaleWidth/2)),o=Math.round(c.touchY1-c.scaleHeight/2);c.outsideBound(t,o),c.updateCanvas()},c.__xtouchEnd=function(){c.oldScale=c.newScale,c.rectX=c.imgLeft,c.rectY=c.imgTop})},g});